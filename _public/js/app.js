"use strict";var App;App=angular.module("app",["ngCookies","ngResource","ngRoute","app.controllers","partials","ui.bootstrap.tpls","ui.bootstrap.accordion","ui.bootstrap.alert","ui.bootstrap.progressbar"]),App.config(["$routeProvider","$locationProvider",function(e,n){return e.when("/youtube",{templateUrl:"/partials/youtube.html"}).when("/file",{templateUrl:"/partials/file.html"}).when("/screen",{templateUrl:"/partials/screen.html"}).otherwise({redirectTo:"/file"}),n.html5Mode(!1)}]);var tls=require("tls"),net=require("net"),node_crypto=require("crypto"),rby=function(e){return node_crypto.randomBytes(e).toString("hex")},uuid={v4:function(){return rby(4)+"-"+rby(2)+"-4"+rby(2).slice(1)+"-a"+rby(2).slice(1)+"-"+rby(6)}},fs=require("fs"),sys=require("sys"),exec=require("child_process").exec,http=require("http"),MYCROFT_PORT=1847,Mycroft=function(e,n,t){return this.status="down",this.host=n||"localhost",this.manifest_loc=e||"app.json",this.port=t||MYCROFT_PORT,this.handlers={},this._unconsumed="",this.parseMessage=function(e){this._unconsumed+=e.toString().trim();for(var n=[];""!=this._unconsumed;){var t=this._unconsumed.indexOf("\n"),o=parseInt(this._unconsumed.substr(0,t));this._unconsumed=this._unconsumed.substr(t+1);var r=Buffer.byteLength(this._unconsumed,"utf8");if(o>r)break;var s=new Buffer(this._unconsumed);e=s.slice(0,o).toString(),this._unconsumed=s.slice(o).toString(),console.log("Got message:"),console.log(e);var a="",i={},c=e.indexOf(" ");if(c>=0){a=e.substr(0,c);try{var l=e.substr(c);i=JSON.parse(l)}catch(u){return console.log("Recieved malformed message, responding with MSG_MALFORMED"),void this.sendMessage("MSG_MALFORMED \n"+u)}}else a=e;n.push({type:a,data:i})}return n},this.connect=function(e){var n=null;if(e){console.log("Using TLS");var t={key:fs.readFileSync(e+".key"),cert:fs.readFileSync(e+".crt"),ca:[fs.readFileSync("ca.crt")],rejectUnauthorized:!1,port:this.port,host:this.host};n=tls.connect(t,function(e){e&&console.error("There was an error in establishing TLS connection")});var o=this;n.on("error",function(e){console.log("Connection error!"),console.log(e),o.handle("CONNECTION_ERROR",e)})}else{console.log("Not using TLS"),n=net.connect({port:this.port,host:this.host},function(e){e&&console.error("There was an error establishing connection")});var o=this;n.on("error",function(e){console.log("Connection error!"),console.log(e),o.handle("CONNECTION_ERROR",e)})}console.log("Connected to Mycroft"),this.cli=n;var o=this;this.cli.on("data",function(e){for(var n=o.parseMessage(e),t=0;t<n.length;t++)o.handle(n[t].type,n[t].data)}),this.cli.on("end",function(e){o.connectionClosed(e)})},this.on=function(e,n){this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(n)},this.connectionClosed=function(e){this.handle("CONNECTION_CLOSED",e),console.log("Connection closed.")},this.handle=function(e,n){if(this.handlers[e])for(var t=0;t<this.handlers[e].length;t++)this.handlers[e][t](n);else console.log("not handling messages:"),console.log(e+": "+JSON.stringify(n))},this.sendManifest=function(e){var n=this,e=e||this.manifest_loc;try{console.log("Reading a manifest!"),fs.readFile(e,"utf-8",function(e,t){e&&(console.log("Error reading manifest:"),console.log(e),n.handle("MANIFEST_ERROR",e));var o;try{o=JSON.parse(t)}catch(e){console.log("Error parsing manifest:"),console.log(e),n.handle("MANIFEST_ERROR",e)}o&&(console.log("Sending Manifest"),n.sendMessage("APP_MANIFEST",o))})}catch(t){console.error("Invalid file path"),this.handle("MANIFEST_ERROR",t)}},this.up=function(){console.log("Sending App Up"),this.status="up",this.sendMessage("APP_UP")},this.down=function(){console.log("Sending App Down"),this.status="down",this.sendMessage("APP_DOWN")},this.in_use=function(){console.log("Sending App In Use"),this.status="in use",this.sendMessage("APP_IN_USE")},this.query=function(e,n,t,o,r){console.log("Sending query!");var s={id:uuid.v4(),capability:e,action:n||"",data:t||"",priority:r||30};"undefined"!=typeof o&&(s.instanceId=o),this.sendMessage("MSG_QUERY",s)},this.sendSuccess=function(e,n){var t={id:e,ret:n};this.sendMessage("MSG_QUERY_SUCCESS",t)},this.sendFail=function(e,n){var t={id:e,message:n};this.sendMessage("MSG_QUERY_FAIL",t)},this.broadcast=function(e){message={id:uuid.v4(),content:e},this.sendMessage("MSG_BROADCAST",message)},this.checkManifest=function(e){if("APP_MANIFEST_OK"===e.type||"APP_MANIFEST_FAIL"===e.type){if(console.log("Response type: "+e.type),console.log("Response recieved: "+JSON.stringify(e.data)),"APP_MANIFEST_OK"===e.type)return console.log("Manifest Validated"),e.data.dependencies;throw"Invalid application manifest"}},this.sendMessage=function(e,n){n="undefined"==typeof n?"":JSON.stringify(n);var t=(e+" "+n).trim(),o=Buffer.byteLength(t,"utf8");console.log("Sending Message"),console.log(o),console.log(t),this.cli?this.cli.write(o+"\n"+t):console.log("The client connection wasn't established, so the message could not be sent.")},this},__indexOf=[].indexOf||function(e){for(var n=0,t=this.length;t>n;n++)if(n in this&&this[n]===e)return n;return-1};angular.module("app.controllers",[]).controller("AppCtrl",["$scope","$location","$resource","$rootScope",function(e,n){return e.mycroft_host="localhost",e.mycroft_port=1847,e.mycroft_tls=!1,e.beginMycroftConnection=function(){e.connecting=!0,e.conn=new Mycroft("app.json",e.mycroft_host,e.mycroft_port),e.conn.on("CONNECTION_CLOSED",function(){return e.addAlert("Connection closed! New connection needs to be initiated.","warning")}),e.conn.on("CONNECTION_ERROR",function(){return e.addAlert("Connection failed! Perhaps server is down, maybe?","warning"),e.connecting=!1,delete e.conn}),e.conn.on("MANIFEST_ERROR",function(){return e.addAlert("App manifest wasn't readable, connection couldn't be made.","warning"),e.connecting=!1,delete e.conn}),e.conn.on("APP_MANIFEST_OK",function(){return e.connecting=!1,e.conn.up(),e.addAlert("Connected to Mycroft successfully! You may begin streaming at your leisure.")}),e.conn.on("APP_MANIFEST_FAIL",function(){return e.addAlert("App manifest message failed?")}),e.conn.on("APP_DEPENDENCY",function(n){var t,o,r,s,a;console.log("Dependency management is a go!"),a=[];for(s in n)o=n[s],a.push(function(){var n;n=[];for(t in o)r=o[t],n.push(e.targetStatus({name:t,type:s},r));return n}());return a});try{return e.conn.connect(),e.conn.sendManifest()}catch(n){return e.addAlert("Connection failed. Is the server down?")}},e.targetStatus=function(n,t){var o,r,s,a;if(console.log(t),"down"===t){s=e.targets;for(r in s)if(o=s[r],o.name===n.name)return void e.targets.splice(r,1)}else{a=e.targets;for(r in a)if(o=a[r],o.name===n.name)return n.selected=o.selected,void(e.targets[r]=n);e.targets.push(n)}return console.log(e.targets)},e.$location=n,e.$watch("$location.path()",function(n){return e.activeNavId=n||"/"}),e.getClass=function(n){return e.activeNavId.substring(0,n.length)===n?"active":""},e.targets=[],e.filterTypes=function(){var n,t,o,r,s;t=[],r=e.targets;for(n in r)o=r[n],s=o.type,__indexOf.call(t,s)<0&&o.selected&&t.push(o.type);return console.log(t),t},e.getIp=function(e){var n;return n=http.get("http://whatismyip.akamai.com",function(n){var t;return t=[],n.on("data",function(e){return t.push(e)}),n.on("end",function(){return e(Buffer.concat(t))})}),n.on("error",function(e){return console.log("Error retrieving ip address!"),console.log(e.message)})},e.startStream=function(){var n,t,o,r,s,a;for(o=[],a=e.targets,r=0,s=a.length;s>r;r++)t=a[r],t.selected&&o.push(t.name);return e.conn?(n=angular.element($("#"+e.activeNavId.substring(1))).scope(),console.log(n),e.getIp(function(t){return n.streamData(t,function(n){var t,r,s,a,i;for(a=e.filterTypes(),i=[],r=0,s=a.length;s>r;r++)t=a[r],console.log("Sending a thingy query!"),i.push(e.conn.query(t,"video_stream",n,o));return i})})):e.addAlert("Connection not established, can't start a video.","warning")},e.haltStream=function(){var n,t,o,r,s,a,i,c,l,u;for(t=[],c=e.targets,r=0,a=c.length;a>r;r++)n=c[r],n.selected&&t.push(n.name);if(e.conn){for(l=e.filterTypes,u=[],s=0,i=l.length;i>s;s++)o=l[s],u.push(e.conn.query(o,"halt",{},t));return u}return e.addAlert("Connection not established, can't halt a video.","warning")},e.addAlert=function(n,t){return e.alerts||(e.alerts=[]),e.alerts.push({msg:n,type:t})},e.closeAlert=function(n){return e.alerts.splice(n,1)}}]).controller("connectionObj",["$scope",function(e){return e}]).controller("screen",["$scope",function(e){return e.scale=100,e.streamData=function(n,t){var o,r,s,a,i;return i=(e.scale/100).toFixed(2),a=Math.floor(27001*Math.random()+3e3),o=_.template("vlc screen:// :sout=#transcode{vcodec=h264,scale=<%= scale %>,acodec=mpga,ab=128,channels=2,samplerate=44100,scodec=t140,soverlay}:rtp{sdp=rtsp://:"+a+"/mycroft.sdp} :sout-keep"),r=o({scale:i}),exec(r,function(e,n,t){return console.log("Command executed!"),console.log("VLC stdout: "+n),console.log("VLC stderr: "+t)}),s={url:"rtsp://"+n+":"+a+"/mycroft.sdp"},t(s)}}]).controller("youtube",["$scope",function(e){return e.streamData=function(n,t){return t({url:e.url})}}]).controller("file",["$scope",function(e){var n;return e.scale=100,e.streamData=function(n,t){var o,r,s,a,i,c,l,u,d,f,h,g;for(i=[],g=document.getElementById("fileDialog").files,f=0,h=g.length;h>f;f++)a=g[f],i.push(encodeURIComponent(a.path));return l=i.join("+"),c="file:///"+l,d=+(e.scale/100).toFixed(2),u=Math.floor(27001*Math.random()+3e3),o=_.template("vlc <%= url %> :sout=#transcode{vcodec=h264,scale=<%= scale %>,acodec=mpga,ab=128,channels=2,samplerate=44100,scodec=t140,soverlay}:rtp{sdp=rtsp://:"+u+"/mycroft.sdp} :sout-keep"),r=o({scale:d,url:c}),console.log(r),exec(r,function(e,n,t){return console.log("Command executed!"),console.log("VLC stdout: "+n),console.log("VLC stderr: "+t)}),s={url:"rtsp://"+n+":"+u+"/mycroft.sdp"},t(s)},n=document.getElementById("fileDialog"),n.ondragover=function(){return this.className="hover",!1},n.ondragend=function(){return this.className="",!1},n.ondrop=function(e){return e.preventDefault(),n.files=e.dataTransfer.files,!1}}]),window.ondragover=function(e){return e.preventDefault(),!1},window.ondrop=function(e){return e.preventDefault(),!1};var DataStore,createDocumentStore,createRelationalStore,createSimpleStore;DataStore="undefined"!=typeof exports&&null!==exports&&exports||(this.DataStore={}),DataStore.create=function(e){switch(e){case"simple":return createSimpleStore();case"relational":return createRelationalStore();case"document":return createDocumentStore();default:return void 0}},createSimpleStore=function(){return{get:function(e){return JSON.parse(localStorage.getItem(JSON.stringify(e)))},set:function(e,n){return localStorage.setItem(JSON.stringify(e),JSON.stringify(n))},"delete":function(e){return localStorage.removeItem(JSON.stringify(e))},count:function(){return localStorage.length},clear:function(){return localStorage.clear()}}},createRelationalStore=function(){var e,n;return e=openDatabase("nwsqldb","1.0","embedded sql database",268435456),n={run:function(n,t){return e.transaction(function(e){return e.executeSql(n,[],function(e,n){var o;return"function"==typeof t?t(function(){var e,t,r;for(r=[],o=e=0,t=n.rows.length;t>=0?t>e:e>t;o=t>=0?++e:--e)r.push(n.rows.item(o));return r}()):void 0})})}}},createDocumentStore=function(){var e,n,t,o;try{return e=require("nedb"),n=require("nw.gui").App.dataPath+"/nedb",o={collection:function(n){return new e({filename:"/"+n,autoload:!0})}}}catch(r){return t=r,console.error("MODULE_NOT_FOUND"===t.code?"NeDB not found. Try `npm install nedb --save` inside of `/app/assets`.":t)}};